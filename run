#!/bin/bash

cdir=$(pwd)
app=$(basename "$cdir")
venv="$cdir"/venv
bin="$venv"/bin

build() { # build the app for pypi
    echo "‚öôÔ∏è building $app..."
    if cleanup && tests; then
        "$bin"/python -m build
    else
        echo "‚ùå build was unsuccessful"
    fi
}

check() { # check the app long description
    echo "üìù checking long description"
    "$bin"/twine check dist/*
}

cleanup() { # lint app
    echo "‚è±Ô∏è isort"
    "$bin"/isort src tests
    echo "‚è±Ô∏è black"
    "$bin"/black src tests
    echo "‚è±Ô∏è flake8"
    "$bin"/flake8 src tests
    echo "‚è±Ô∏è ruff"
    "$bin"/ruff src tests
    typing
}

typing() { # type check app
    echo "‚è±Ô∏è type checking with mypy"
    "$bin"/mypy src tests
}

tests() { # test app using pytest
    echo "üßæ testing $app..."
    "$bin"/pytest -vv --cov-report term-missing
}

upload() { # upload to pypi
    echo "‚¨ÜÔ∏è uploading $app to pypi..."
    "$bin"/twine upload dist/*
}

help() {
  printf "%s <task> [args]\n\nTasks:\n" "${0}"

  compgen -A function | grep -v "^_" | cat -n

  printf "\nExtended help:\n  Each task has comments for general usage\n"
}

TIMEFORMAT=$'\nTask completed in %3lR'
time "${@:-help}"
